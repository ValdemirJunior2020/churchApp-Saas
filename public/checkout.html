<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Congregate — Subscribe</title>
    <style>
      :root {
        --bg: #0b1220;
        --card: rgba(255,255,255,0.08);
        --stroke: rgba(255,255,255,0.14);
        --text: #eaf2ff;
        --muted: rgba(234,242,255,0.75);
        --ok: rgba(34,197,94,0.18);
        --okStroke: rgba(34,197,94,0.35);
        --bad: rgba(239,68,68,0.18);
        --badStroke: rgba(239,68,68,0.35);
      }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: radial-gradient(1200px 700px at 20% 10%, rgba(37,99,235,.22), transparent 60%), radial-gradient(900px 600px at 90% 20%, rgba(34,197,94,.12), transparent 55%), var(--bg); color: var(--text); }
      .wrap { max-width: 980px; margin: 0 auto; padding: 28px 16px 60px; }
      .card { background: var(--card); border: 1px solid var(--stroke); border-radius: 18px; padding: 18px; box-shadow: 0 18px 50px rgba(0,0,0,.35); }
      .row { display:flex; gap:16px; flex-wrap:wrap; }
      .col { flex: 1 1 340px; min-width: 300px; }
      h1 { margin: 0 0 6px; font-size: 22px; letter-spacing: .2px; }
      .muted { color: var(--muted); font-size: 13px; }
      .pill { display:inline-flex; align-items:center; gap:8px; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--stroke); background: rgba(255,255,255,0.06); font-size: 12px; }
      .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
      .kv { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); border-radius: 14px; padding: 10px; }
      .kv b { display:block; font-size: 12px; opacity: .8; margin-bottom: 6px; }
      .kv span { font-size: 14px; }
      #paypal-buttons { margin-top: 14px; }
      .note { margin-top: 12px; font-size: 12px; color: var(--muted); line-height: 1.45; }
      .box { margin-top: 12px; padding: 12px; border-radius: 14px; border: 1px solid var(--stroke); background: rgba(255,255,255,0.06); }
      .ok { border-color: var(--okStroke); background: var(--ok); }
      .bad { border-color: var(--badStroke); background: var(--bad); }
      pre { margin: 0; white-space: pre-wrap; word-break: break-word; font-size: 12px; }
      button.small { margin-top: 10px; padding: 10px 12px; border-radius: 12px; background: rgba(255,255,255,0.10); color: var(--text); border: 1px solid var(--stroke); cursor:pointer; }
      button.small:hover { background: rgba(255,255,255,0.16); }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="row">
        <div class="col card">
          <h1>Congregate — Subscription</h1>
          <div class="muted">
            This page loads your PayPal Client ID + Plan ID from your Apps Script session (no placeholders).
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <span class="pill">Session: <span id="sess">—</span></span>
            <span class="pill">Env: <span id="env">—</span></span>
            <span class="pill">Church: <span id="cc">—</span></span>
          </div>

          <div class="grid">
            <div class="kv"><b>Church Name</b><span id="churchName">—</span></div>
            <div class="kv"><b>Admin Email</b><span id="adminEmail">—</span></div>
            <div class="kv"><b>Plan</b><span id="plan">—</span></div>
            <div class="kv"><b>Price</b><span id="price">—</span></div>
          </div>

          <div id="paypal-buttons"></div>

          <div class="note">
            If you see <b>RESOURCE_NOT_FOUND / INVALID_RESOURCE_ID</b>, your <b>Plan ID</b> does not exist in the same PayPal environment/account as your Client ID.
            Use the “Test Plan” button below to confirm from your Apps Script.
          </div>

          <button class="small" id="btnTestPlan">Test Plan (from Apps Script)</button>
        </div>

        <div class="col card">
          <h1>Debug</h1>
          <div class="muted">Shows the exact error PayPal returns.</div>

          <div id="statusBox" class="box">
            <pre id="status">Loading…</pre>
          </div>

          <div class="box">
            <b style="display:block;margin-bottom:8px;">Params</b>
            <pre id="params"></pre>
          </div>
        </div>
      </div>
    </div>

    <form id="completeForm" method="POST" style="display:none;">
      <input name="resource" value="billing" />
      <input name="action" value="complete" />
      <input name="returnHtml" value="1" />
      <input name="sessionId" id="f_sessionId" />
      <input name="subscriptionId" id="f_subscriptionId" />
    </form>

    <script>
      const $ = (id) => document.getElementById(id);

      function setBox(type, obj) {
        const box = $("statusBox");
        box.className = "box " + (type === "ok" ? "ok" : type === "bad" ? "bad" : "");
        $("status").textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      }

      function getParam(name) {
        const u = new URL(location.href);
        return u.searchParams.get(name) || "";
      }

      // JSONP loader (bypasses CORS)
      function jsonp(url) {
        return new Promise((resolve, reject) => {
          const cb = "__cb_" + Math.random().toString(16).slice(2);
          const s = document.createElement("script");
          const sep = url.includes("?") ? "&" : "?";
          s.src = url + sep + "callback=" + encodeURIComponent(cb);
          s.async = true;

          window[cb] = (data) => {
            try { delete window[cb]; } catch(_) { window[cb] = undefined; }
            s.remove();
            resolve(data);
          };

          s.onerror = () => {
            try { delete window[cb]; } catch(_) { window[cb] = undefined; }
            s.remove();
            reject(new Error("JSONP failed to load: " + s.src));
          };

          document.head.appendChild(s);
        });
      }

      function loadPayPalSdk(clientId, currency) {
        return new Promise((resolve, reject) => {
          if (window.paypal) return resolve();

          const s = document.createElement("script");
          s.src =
            "https://www.paypal.com/sdk/js" +
            "?client-id=" + encodeURIComponent(clientId) +
            "&vault=true" +
            "&intent=subscription" +
            "&currency=" + encodeURIComponent(currency || "USD") +
            "&components=buttons";
          s.async = true;
          s.onload = resolve;
          s.onerror = () => reject(new Error("Failed to load PayPal SDK"));
          document.head.appendChild(s);
        });
      }

      async function main() {
        const sessionId = getParam("sessionId");
        const exec = getParam("exec");

        $("params").textContent = JSON.stringify({ sessionId, exec }, null, 2);

        if (!sessionId || !exec) {
          setBox("bad", "Missing sessionId or exec in the URL.\n\nYou MUST open the link returned by billing/start.");
          return;
        }

        $("sess").textContent = sessionId;
        $("f_sessionId").value = sessionId;

        setBox("", "Loading session from Apps Script…");

        const session = await jsonp(exec + "?resource=billing&action=session&sessionId=" + encodeURIComponent(sessionId));
        if (!session || !session.ok) {
          setBox("bad", session || "Unknown session error");
          return;
        }

        $("env").textContent = session.env;
        $("cc").textContent = session.churchCode;
        $("churchName").textContent = session.churchName;
        $("adminEmail").textContent = session.adminEmail;
        $("plan").textContent = session.plan;
        $("price").textContent = "$" + session.price + " " + session.currency + " / " + session.interval;

        // Test-plan button (calls Apps Script -> PayPal -> GET /plans/{id})
        $("btnTestPlan").onclick = async () => {
          try {
            setBox("", "Testing plan from Apps Script…");
            const plan = await jsonp(exec + "?resource=debug&action=plan&planId=" + encodeURIComponent(session.paypalPlanId));
            setBox(plan.exists ? "ok" : "bad", plan);
          } catch (err) {
            setBox("bad", String(err && err.message ? err.message : err));
          }
        };

        // Load PayPal SDK using clientId from Apps Script (NO placeholders!)
        await loadPayPalSdk(session.paypalClientId, session.currency);

        setBox("ok", {
          ok: true,
          message: "PayPal SDK loaded. Rendering Subscribe button…",
          paypalClientId: session.paypalClientId,
          paypalPlanId: session.paypalPlanId,
          env: session.env,
        });

        window.paypal
          .Buttons({
            style: { label: "subscribe", layout: "vertical", color: "gold", shape: "pill", tagline: false },
            createSubscription: function (data, actions) {
              // If this throws RESOURCE_NOT_FOUND, your planId is wrong for this clientId/env.
              return actions.subscription.create({
                plan_id: session.paypalPlanId,
                custom_id: session.churchCode,
              });
            },
            onApprove: function (data) {
              // data.subscriptionID
              $("f_subscriptionId").value = data.subscriptionID;

              // POST back to Apps Script to verify + activate (returns HTML redirect to deep link)
              const form = $("completeForm");
              form.action = exec;
              form.submit();
            },
            onError: function (err) {
              setBox("bad", {
                message: "PayPal error",
                err: String(err && err.message ? err.message : err),
              });
            },
          })
          .render("#paypal-buttons");
      }

      main().catch((err) => setBox("bad", String(err && err.message ? err.message : err)));
    </script>
  </body>
</html>